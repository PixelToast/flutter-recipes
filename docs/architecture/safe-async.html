<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Safe Async - ping's cookbook</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-114525654-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', "UA-114525654-1"); </script> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Safe Async | ping’s cookbook</title> <meta name="generator" content="Jekyll v3.8.7" /> <meta property="og:title" content="Safe Async" /> <meta property="og:locale" content="en_US" /> <meta property="og:site_name" content="ping’s cookbook" /> <script type="application/ld+json"> {"@type":"WebPage","headline":"Safe Async","url":"/docs/architecture/safe-async.html","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <script src="https://i.tst.sh/QQBGy.js"></script> <script type="text/javascript" src="/assets/js/bloglint.js"></script> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"> <title>Link</title> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path> </symbol> </svg> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="" class="site-title lh-tight"> ping's cookbook </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item"><a href="/" class="navigation-list-link"> About</a></li><li class="navigation-list-item"><a href="/docs/faq/" class="navigation-list-link"> FAQ</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="/docs/faq/avd-amd.html" class="navigation-list-link"> Android Emulator on AMD CPUs</a></li><li class="navigation-list-item "><a href="/docs/faq/custom-scroll-view.html" class="navigation-list-link"> CustomScrollView</a></li><li class="navigation-list-item "><a href="/docs/faq/dart-defines.html" class="navigation-list-link"> Dart defines</a></li><li class="navigation-list-item "><a href="/docs/faq/experiment-not-enabled.html" class="navigation-list-link"> experiment_not_enabled</a></li><li class="navigation-list-item "><a href="/docs/faq/ignore-overflow.html" class="navigation-list-link"> Ignoring overflow</a></li><li class="navigation-list-item "><a href="/docs/faq/intellij-observatory.html" class="navigation-list-link"> IntelliJ Observatory</a></li><li class="navigation-list-item "><a href="/docs/faq/type-system.html" class="navigation-list-link"> Type system</a></li></ul></li><li class="navigation-list-item"><a href="/docs/reverse-engineering/" class="navigation-list-link"> Reverse Engineering</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="/docs/reverse-engineering/snapshots.html" class="navigation-list-link"> Snapshots</a></li><li class="navigation-list-item "><a href="/docs/reverse-engineering/dart-sdk.html" class="navigation-list-link"> The Dart SDK</a></li><li class="navigation-list-item "><a href="/docs/reverse-engineering/anatomy-of-a-snapshot.html" class="navigation-list-link"> Anatomy of a snapshot</a></li><li class="navigation-list-item "><a href="/docs/reverse-engineering/rawobject.html" class="navigation-list-link"> RawObject</a></li><li class="navigation-list-item "><a href="/docs/reverse-engineering/hello-world.html" class="navigation-list-link"> Hello, World!</a></li></ul></li><li class="navigation-list-item active"><a href="/docs/architecture/" class="navigation-list-link"> Architecture</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="/docs/architecture/countdown.html" class="navigation-list-link"> Countdown</a></li><li class="navigation-list-item "><a href="/docs/architecture/download-progress.html" class="navigation-list-link"> Download Progress</a></li><li class="navigation-list-item "><a href="/docs/architecture/efficient-painter.html" class="navigation-list-link"> Efficient painter<div class="nav-wip">WIP</div></a></li><li class="navigation-list-item "><a href="/docs/architecture/nesting-async-builders.html" class="navigation-list-link"> Nesting async builders</a></li><li class="navigation-list-item "><a href="/docs/architecture/project_structure.html" class="navigation-list-link"> Project Structure</a></li><li class="navigation-list-item active"><a href="/docs/architecture/safe-async.html" class="navigation-list-link active"> Safe Async</a></li></ul></li><li class="navigation-list-item"><a href="/docs/framework/" class="navigation-list-link"> Framework<div class="nav-wip">WIP</div></a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="/docs/framework/render-layer.html" class="navigation-list-link"> Render Layer<div class="nav-wip">WIP</div></a></li><li class="navigation-list-item "><a href="/docs/framework/single-child-render-objects.html" class="navigation-list-link"> Single Child Render Objects</a></li></ul></li><li class="navigation-list-item"><a href="/docs/performance/" class="navigation-list-link"> Performance</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="/docs/performance/diagnostics.html" class="navigation-list-link"> Diagnostics</a></li><li class="navigation-list-item "><a href="/docs/performance/timeline.html" class="navigation-list-link"> Timeline<div class="nav-wip">WIP</div></a></li></ul></li><li class="navigation-list-item"><a href="/docs/packages/" class="navigation-list-link"> Packages</a></li><li class="navigation-list-item"><a href="/docs/design/" class="navigation-list-link"> Design<div class="nav-wip">WIP</div></a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="/docs/design/mediaquery.html" class="navigation-list-link"> MediaQuery<div class="nav-wip">WIP</div></a></li></ul></li></ul> </nav> </div> <!-- <footer class="site-footer"> <p class="text-small text-grey-dk-000 mb-4">By <a href="https://me.tst.sh/">PixelToast</a> - <a href="https://github.com/PixelToast/flutter-recipes/">GitHub</a><br/>Theme based on <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a></p> </footer> --> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content"> <div class="page-header js-page-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search" aria-label="Search" autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg> </div> <div class="js-search-results search-results-wrap"></div> </div> </div> <div class="page"> <nav class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/docs/architecture/">Architecture</a></li> <li class="breadcrumb-nav-list-item"><span>Safe Async</span></li> </ol> </nav> <div id="main-content" class="page-content" role="main"> <h1 id="safe-async"> <a href="#safe-async" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Safe Async </h1> <h2 id="common-mistake"> <a href="#common-mistake" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Common mistake </h2> <p>Quite frequently I see code using <code class="language-plaintext highlighter-rouge">FutureBuilder</code> or <code class="language-plaintext highlighter-rouge">StreamBuilder</code> incorrectly:</p> <div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">StreamBuilder</span><span class="o">&lt;</span><span class="n">DocumentSnapshot</span><span class="o">&gt;(</span>
  <span class="nl">stream:</span> <span class="n">Firestore</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">collection</span><span class="o">(</span><span class="s">'foobar'</span><span class="o">).</span><span class="na">snapshots</span><span class="o">(),</span>
  <span class="nl">builder:</span> <span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">snapshot</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">snapshot</span><span class="o">.</span><span class="na">hasData</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">Text</span><span class="o">(</span><span class="s">'</span><span class="si">${snapshot.data}</span><span class="s">'</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">CircularProgressIndicator</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">},</span>
<span class="o">)</span>
</code></pre></div></div> <p>Despite looking quite innocent, this is problematic for a few reasons:</p> <ol> <li>Errors from the AsyncSnapshot are silently ignored.</li> <li>An async task is started during build, which will re-start when rebuilt.</li> <li>Direct query instead of a request through state management or a network layer.</li> </ol> <p>Thankfully these issues are easy to fix, the rest of this post provides in-depth suggestions for each.</p> <hr /> <h2 id="error-handling"> <a href="#error-handling" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Error handling </h2> <p>FutureBuilder and StreamBuilder have flaws when it comes to error handling, the only way to know if an error has occurred is to manually either:</p> <ol type="a"> <li>Use <code class="language-plaintext highlighter-rouge">Future.catchError</code> or <code class="language-plaintext highlighter-rouge">Stream.handleError</code>, requiring an extra closure.</li> <li>Print the error in the AsyncSnapshot without a stack trace, duplicating the message when it rebuilds.</li> </ol> <p>This is far from ideal, thankfully there is a better solution in <a href="https://pub.dev/packages/async_builder">package:async_builder</a>. This package provides the <a href="https://pub.dev/documentation/async_builder/latest/async_builder/AsyncBuilder-class.html">AsyncBuilder</a> Widget which allows you to rewrite the above code to the following:</p> <div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AsyncBuilder</span><span class="o">&lt;</span><span class="n">DocumentSnapshot</span><span class="o">&gt;(</span>
  <span class="nl">stream:</span> <span class="n">Firestore</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">collection</span><span class="o">(</span><span class="s">'foobar'</span><span class="o">).</span><span class="na">snapshots</span><span class="o">(),</span>
  <span class="nl">waiting:</span> <span class="o">(</span><span class="n">context</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">CircularProgressIndicator</span><span class="o">(),</span>
  <span class="nl">builder:</span> <span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">data</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">Text</span><span class="o">(</span><span class="s">'</span><span class="si">$data</span><span class="s">'</span><span class="o">),</span>
<span class="o">)</span>
</code></pre></div></div> <p>This will properly handle errors emitted by the stream or future, including printing the stack trace and other debug information like where the widget is located in the tree.</p> <p>That solves error handling, but this sample code still has another flaw which is that building it has side effects.</p> <hr /> <h2 id="avoiding-build-side-effects"> <a href="#avoiding-build-side-effects" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Avoiding build side effects </h2> <p>If you call a function directly to start an asynchronous task during build, that task will restart whenever the widget re-builds, potentially causing loss of state, infinite loops, and annoying flashes.</p> <p>So starting asynchronous tasks like <code class="language-plaintext highlighter-rouge">Firestore.instance.collection('foobar').snapshots()</code> during build is bad practice, what should we do instead?</p> <p>The two approaches I will cover are:</p> <ol> <li><a href="#the-widget-solution">The widget solution</a></li> <li><a href="#the-state-management-solution">The state management solution</a></li> </ol> <hr /> <h2 id="the-widget-solution"> <a href="#the-widget-solution" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> The Widget solution </h2> <p>The most basic solution is to create a new StatefulWidget and start the asynchronous task inside of initState.</p> <div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">_MyWidetState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">MyWidet</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="n">Stream</span><span class="o">&lt;</span><span class="n">DocumentSnapshot</span><span class="o">&gt;</span> <span class="n">foobar</span><span class="o">;</span>

  <span class="nd">@override</span>
  <span class="kt">void</span> <span class="n">initState</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">super</span><span class="o">.</span><span class="na">initState</span><span class="o">();</span>
    <span class="n">foobar</span> <span class="o">=</span> <span class="n">Firestore</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">collection</span><span class="o">(</span><span class="s">'foobar'</span><span class="o">).</span><span class="na">snapshots</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="o">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">AsyncBuilder</span><span class="o">(</span>
    <span class="nl">stream:</span> <span class="n">foobar</span><span class="o">,</span>
    <span class="nl">builder:</span> <span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">snapshot</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="o">...,</span>
  <span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div> <p>Now our request will not restart every build, nice!</p> <p>We can do better though, <a href="https://pub.dev/packages/async_builder">package:async_builder</a> also includes <a href="https://pub.dev/documentation/async_builder/latest/init_builder/InitBuilder-class.html">InitBuilder</a> which is a widget that can initialize and cache our stream safely.</p> <p>Instead of creating a whole new StatefulWidget, we can do this instead:</p> <div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyWidget</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="o">{</span>
  <span class="kd">static</span> <span class="n">Stream</span><span class="o">&lt;</span><span class="n">DocumentSnapshot</span><span class="o">&gt;</span> <span class="n">getFoobar</span><span class="o">()</span> <span class="o">=&gt;</span>
    <span class="n">Firestore</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">collection</span><span class="o">(</span><span class="s">'foobar'</span><span class="o">).</span><span class="na">snapshots</span><span class="o">();</span>
  
  <span class="nd">@override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="o">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">InitBuilder</span><span class="o">(</span>
    <span class="nl">getter:</span> <span class="n">getFoobar</span><span class="o">,</span>
    <span class="nl">builder:</span> <span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">stream</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">AsyncBuilder</span><span class="o">&lt;</span><span class="n">DocumentSnapshot</span><span class="o">&gt;(</span>
      <span class="nl">stream:</span> <span class="n">stream</span><span class="o">,</span>
      <span class="nl">waiting:</span> <span class="o">(</span><span class="n">context</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="o">...,</span>
      <span class="nl">builder:</span> <span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">snapshot</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="o">...,</span>
    <span class="o">),</span>
  <span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div> <p>Making <code class="language-plaintext highlighter-rouge">getFoobar</code> static here is important, if we pass it an anonymous function directly it would be forced to make the request every build because the closure instance would be different.</p> <p>But what if your getter takes arguments, like requesting from an http api for example?</p> <p>With StatefulWidget, this is a bit involved because you have to check if the key changed after being rebuilt:</p> <div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyWidget</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="o">{</span>
  <span class="n">MyWidget</span><span class="o">({</span><span class="k">this</span><span class="o">.</span><span class="na">keyName</span><span class="o">});</span>

  <span class="kd">final</span> <span class="kt">String</span> <span class="n">keyName</span><span class="o">;</span>

  <span class="nd">@override</span>
  <span class="n">_MyWidgetState</span> <span class="n">createState</span><span class="o">()</span> <span class="o">=&gt;</span> <span class="n">_MyWidgetState</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">_MyWidetState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">MyWidet</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="n">Future</span><span class="o">&lt;</span><span class="kt">String</span><span class="o">&gt;</span> <span class="n">future</span><span class="o">;</span>

  <span class="kt">void</span> <span class="n">updateFuture</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">widget</span><span class="o">.</span><span class="na">keyName</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@override</span>
  <span class="kt">void</span> <span class="n">initState</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">super</span><span class="o">.</span><span class="na">initState</span><span class="o">();</span>
    <span class="n">updateFuture</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@override</span>
  <span class="kt">void</span> <span class="n">didUpdateWidget</span><span class="o">(</span><span class="n">MyWidget</span> <span class="n">oldWidget</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">widget</span><span class="o">.</span><span class="na">keyName</span> <span class="o">!=</span> <span class="n">oldWidget</span><span class="o">.</span><span class="na">keyName</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">updateFuture</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
  
  <span class="nd">@override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="o">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">AsyncBuilder</span><span class="o">(</span>
    <span class="nl">stream:</span> <span class="n">future</span><span class="o">,</span>
    <span class="nl">builder:</span> <span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">Text</span><span class="o">(</span><span class="s">'</span><span class="si">$value</span><span class="s">'</span><span class="o">),</span>
  <span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div> <p>With the <code class="language-plaintext highlighter-rouge">InitBuilder.arg</code> constructor this can be rewritten as:</p> <div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyWidget</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="o">{</span>
  <span class="n">MyWidget</span><span class="o">({</span><span class="k">this</span><span class="o">.</span><span class="na">keyName</span><span class="o">});</span>

  <span class="kd">final</span> <span class="kt">String</span> <span class="n">keyName</span><span class="o">;</span>

  <span class="nd">@override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="o">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">InitBuilder</span><span class="o">.</span><span class="na">arg</span><span class="o">&lt;</span><span class="kt">String</span><span class="o">,</span> <span class="kt">String</span><span class="o">&gt;(</span>
    <span class="nl">getter:</span> <span class="n">api</span><span class="o">.</span><span class="na">getString</span><span class="o">,</span>
    <span class="nl">arg:</span> <span class="n">keyName</span><span class="o">,</span>
    <span class="nl">builder:</span> <span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">future</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">AsyncBuilder</span><span class="o">(</span>
      <span class="nl">future:</span> <span class="n">future</span><span class="o">,</span>
      <span class="nl">builder:</span> <span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">Text</span><span class="o">(</span><span class="s">'</span><span class="si">$value</span><span class="s">'</span><span class="o">),</span>
    <span class="o">),</span>
  <span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div> <p>And you are done! The last four examples are safe to use.</p> <hr /> <h2 id="the-state-management-solution"> <a href="#the-state-management-solution" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> The state management solution </h2> <p>Using state management here has two benefits, first it allows you to avoid multiple widgets requesting snapshots at the same time, second it allows you swap out the underlying supplier of information whether it be for tests or to migrate away from firebase.</p> <p>For a continuously updating resource, <a href="https://pub.dev/packages/rxdart">package:rxdart</a> <a href="https://pub.dev/documentation/rxdart/latest/rx/BehaviorSubject-class.html">BehaviorSubject</a>s are a very nice way to hold a value and notify listeners at the same time:</p> <div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyService</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="n">BehaviorSubject</span><span class="o">&lt;</span><span class="n">Foobar</span><span class="o">&gt;</span> <span class="n">_foobar</span><span class="o">;</span> <span class="c1">// Don't forget to dispose!</span>
  
  <span class="n">ValueStream</span><span class="o">&lt;</span><span class="n">Foobar</span><span class="o">&gt;</span> <span class="kd">get</span> <span class="n">foobar</span> <span class="o">=&gt;</span> <span class="n">_foobar</span> <span class="o">??=</span> <span class="n">BehaviorSubject</span><span class="o">&lt;</span><span class="n">Foobar</span><span class="o">&gt;()..</span><span class="na">addStream</span><span class="o">(</span>
    <span class="n">Firestore</span><span class="o">.</span><span class="na">instance</span>
      <span class="o">.</span><span class="na">collection</span><span class="o">(</span><span class="s">'foobar'</span><span class="o">).</span><span class="na">snapshots</span><span class="o">().</span><span class="na">map</span><span class="o">((</span><span class="n">e</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">Foobar</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">data</span><span class="o">))</span>
  <span class="o">);</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div> <p>This basically just creates a <code class="language-plaintext highlighter-rouge">BehaviorSubject</code> that wraps snapshots from the firestore, allowing listeners to have an up to date Foobar without making any new requests.</p> <p>The important part is that the instance is cached, which is very important to prevent side effects.</p> <div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AsyncBuilder</span><span class="o">&lt;</span><span class="n">DocumentSnapshot</span><span class="o">&gt;(</span>
  <span class="nl">stream:</span> <span class="n">MyService</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">context</span><span class="o">).</span><span class="na">foobar</span><span class="o">,</span>
  <span class="nl">waiting:</span> <span class="o">(</span><span class="n">context</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">CircularProgressIndicator</span><span class="o">(),</span>
  <span class="nl">builder:</span> <span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">data</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">Text</span><span class="o">(</span><span class="s">'</span><span class="si">$data</span><span class="s">'</span><span class="o">),</span>
<span class="o">)</span>
</code></pre></div></div> <p>With <a href="https://pub.dev/documentation/async_builder/latest/async_builder/AsyncBuilder-class.html">AsyncBuilder</a>, the builder can use the current value of our <code class="language-plaintext highlighter-rouge">BehaviorSubject</code> on first build, avoiding the single-frame loading indicator that <code class="language-plaintext highlighter-rouge">StreamBuilder</code> would show.</p> <p>If you want something a bit lighter consider using <code class="language-plaintext highlighter-rouge">ValueNotifier</code> / <code class="language-plaintext highlighter-rouge">ValueListenableBuilder</code> instead.</p> <p>But what if you are requesting something based on its key like in the last two StatefulWidget examples?</p> <p>What I typically do in this case is cache the futures or streams in a map:</p> <div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyService</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="kd">final</span> <span class="n">MyApi</span> <span class="n">api</span><span class="o">;</span>

  <span class="kd">var</span> <span class="n">_foobars</span> <span class="o">=</span> <span class="o">&lt;</span><span class="kt">String</span><span class="o">,</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">Foobar</span><span class="o">&gt;&gt;{};</span>

  <span class="n">Future</span><span class="o">&lt;</span><span class="n">Foobar</span><span class="o">&gt;</span> <span class="n">getFoo</span><span class="o">(</span><span class="kt">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">=&gt;</span>
    <span class="n">_foobars</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">??=</span>
      <span class="n">api</span><span class="o">.</span><span class="na">getFoobar</span><span class="o">(</span><span class="n">key</span><span class="o">)</span>
        <span class="o">..</span><span class="na">then</span><span class="o">((</span><span class="n">value</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">_foobars</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">SynchronousFuture</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div> <p>Like before, any tasks created by the service are cached to ensure work isn’t being duplicated.</p> <p>I’m assigning <code class="language-plaintext highlighter-rouge">SynchronousFuture</code> because it allows the value to be available on first build if cached, similar to the <code class="language-plaintext highlighter-rouge">ValueStream</code> example.</p> <div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyWidget</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="o">{</span>
  <span class="n">MyWidget</span><span class="o">({</span><span class="k">this</span><span class="o">.</span><span class="na">keyName</span><span class="o">});</span>

  <span class="kd">final</span> <span class="kt">String</span> <span class="n">keyName</span><span class="o">;</span>

  <span class="nd">@override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="o">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">AsyncBuilder</span><span class="o">&lt;</span><span class="n">Foobar</span><span class="o">&gt;(</span>
    <span class="nl">future:</span> <span class="n">MyService</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">context</span><span class="o">).</span><span class="na">getFoo</span><span class="o">(</span><span class="n">keyName</span><span class="o">),</span>
    <span class="nl">waiting:</span> <span class="o">(</span><span class="n">context</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">CircularProgressIndicator</span><span class="o">(),</span>
    <span class="nl">builder:</span> <span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">data</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">Text</span><span class="o">(</span><span class="s">'</span><span class="si">$data</span><span class="s">'</span><span class="o">),</span>
  <span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div> <p>These are some basic patterns that may or may not apply to your use case, if there is anything missing or if you have questions please don’t hesitate to ping me on Discord.</p> <hr /> </div> </div> </div> </div> </body> </html>
