<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Anatomy of a snapshot - ping's cookbook</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-114525654-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', "UA-114525654-1"); </script> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Anatomy of a snapshot | ping’s cookbook</title> <meta name="generator" content="Jekyll v3.8.7" /> <meta property="og:title" content="Anatomy of a snapshot" /> <meta property="og:locale" content="en_US" /> <meta property="og:site_name" content="ping’s cookbook" /> <script type="application/ld+json"> {"@type":"WebPage","headline":"Anatomy of a snapshot","url":"/docs/reverse-engineering/anatomy-of-a-snapshot.html","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <script src="https://i.tst.sh/QQBGy.js"></script> <script type="text/javascript" src="/assets/js/bloglint.js"></script> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"> <title>Link</title> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path> </symbol> </svg> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="" class="site-title lh-tight"> ping's cookbook </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item"><a href="/" class="navigation-list-link"> About</a></li><li class="navigation-list-item"><a href="/docs/faq/" class="navigation-list-link"> FAQ</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="/docs/faq/avd-amd.html" class="navigation-list-link"> Android Emulator on AMD CPUs</a></li><li class="navigation-list-item "><a href="/docs/faq/custom-scroll-view.html" class="navigation-list-link"> CustomScrollView</a></li><li class="navigation-list-item "><a href="/docs/faq/dart-defines.html" class="navigation-list-link"> Dart defines</a></li><li class="navigation-list-item "><a href="/docs/faq/experiment-not-enabled.html" class="navigation-list-link"> experiment_not_enabled</a></li><li class="navigation-list-item "><a href="/docs/faq/ignore-overflow.html" class="navigation-list-link"> Ignoring overflow</a></li><li class="navigation-list-item "><a href="/docs/faq/intellij-observatory.html" class="navigation-list-link"> IntelliJ Observatory</a></li><li class="navigation-list-item "><a href="/docs/faq/type-system.html" class="navigation-list-link"> Type system</a></li></ul></li><li class="navigation-list-item active"><a href="/docs/reverse-engineering/" class="navigation-list-link"> Reverse Engineering</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="/docs/reverse-engineering/snapshots.html" class="navigation-list-link"> Snapshots</a></li><li class="navigation-list-item "><a href="/docs/reverse-engineering/dart-sdk.html" class="navigation-list-link"> The Dart SDK</a></li><li class="navigation-list-item active"><a href="/docs/reverse-engineering/anatomy-of-a-snapshot.html" class="navigation-list-link active"> Anatomy of a snapshot</a></li><li class="navigation-list-item "><a href="/docs/reverse-engineering/rawobject.html" class="navigation-list-link"> RawObject</a></li><li class="navigation-list-item "><a href="/docs/reverse-engineering/hello-world.html" class="navigation-list-link"> Hello, World!</a></li></ul></li><li class="navigation-list-item"><a href="/docs/architecture/" class="navigation-list-link"> Architecture</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="/docs/architecture/countdown.html" class="navigation-list-link"> Countdown</a></li><li class="navigation-list-item "><a href="/docs/architecture/download-progress.html" class="navigation-list-link"> Download Progress</a></li><li class="navigation-list-item "><a href="/docs/architecture/nesting-async-builders.html" class="navigation-list-link"> Nesting async builders</a></li><li class="navigation-list-item "><a href="/docs/architecture/project_structure.html" class="navigation-list-link"> Project Structure</a></li><li class="navigation-list-item "><a href="/docs/architecture/safe-async.html" class="navigation-list-link"> Safe Async</a></li></ul></li><li class="navigation-list-item"><a href="/docs/framework/" class="navigation-list-link"> Framework<div class="nav-wip">WIP</div></a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="/docs/framework/render-layer.html" class="navigation-list-link"> Render Layer<div class="nav-wip">WIP</div></a></li><li class="navigation-list-item "><a href="/docs/framework/single-child-render-objects.html" class="navigation-list-link"> Single Child Render Objects</a></li></ul></li><li class="navigation-list-item"><a href="/docs/performance/" class="navigation-list-link"> Performance</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="/docs/performance/diagnostics.html" class="navigation-list-link"> Diagnostics</a></li><li class="navigation-list-item "><a href="/docs/performance/timeline.html" class="navigation-list-link"> Timeline<div class="nav-wip">WIP</div></a></li></ul></li><li class="navigation-list-item"><a href="/docs/packages/" class="navigation-list-link"> Packages</a></li><li class="navigation-list-item"><a href="/docs/design/" class="navigation-list-link"> Design<div class="nav-wip">WIP</div></a><ul class="navigation-list-child-list "></ul></li></ul> </nav> </div> <!-- <footer class="site-footer"> <p class="text-small text-grey-dk-000 mb-4">By <a href="https://me.tst.sh/">PixelToast</a> - <a href="https://github.com/PixelToast/flutter-recipes/">GitHub</a><br/>Theme based on <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a></p> </footer> --> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content"> <div class="page-header js-page-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search" aria-label="Search" autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg> </div> <div class="js-search-results search-results-wrap"></div> </div> </div> <div class="page"> <nav class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/docs/reverse-engineering/">Reverse Engineering</a></li> <li class="breadcrumb-nav-list-item"><span>Anatomy of a snapshot</span></li> </ol> </nav> <div id="main-content" class="page-content" role="main"> <h1 id="anatomy-of-a-snapshot"> <a href="#anatomy-of-a-snapshot" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Anatomy of a snapshot </h1> <p>The AOT snapshot itself is quite complex, it is a custom binary format with no documentation. You may be forced to step through the serialization process manually in a debugger to implement a tool that can read the format.</p> <p>The source files relevant to snapshot generation can be found here:</p> <ul> <li>Cluster serialization / deserialization <code class="language-plaintext highlighter-rouge">[vm/clustered_snapshot.h](https://github.com/dart-lang/sdk/blob/7340a569caac6431d8698dc3788579b57ffcf0c6/runtime/vm/clustered_snapshot.h)</code> <code class="language-plaintext highlighter-rouge">[vm/clustered_snapshot.cc](https://github.com/dart-lang/sdk/blob/7340a569caac6431d8698dc3788579b57ffcf0c6/runtime/vm/clustered_snapshot.cc)</code></li> <li>ROData serialization <code class="language-plaintext highlighter-rouge">[vm/image_snapshot.h](https://github.com/dart-lang/sdk/blob/7340a569caac6431d8698dc3788579b57ffcf0c6/runtime/vm/image_snapshot.h)</code> <code class="language-plaintext highlighter-rouge">[vm/image_snapshot.cc](https://github.com/dart-lang/sdk/blob/7340a569caac6431d8698dc3788579b57ffcf0c6/runtime/vm/image_snapshot.cc)</code></li> <li>ReadStream / WriteStream <code class="language-plaintext highlighter-rouge">[vm/datastream.h](https://github.com/dart-lang/sdk/blob/7340a569caac6431d8698dc3788579b57ffcf0c6/runtime/vm/datastream.h)</code></li> <li>Object definitions <code class="language-plaintext highlighter-rouge">[vm/object.h](https://github.com/dart-lang/sdk/blob/7340a569caac6431d8698dc3788579b57ffcf0c6/runtime/vm/object.h)</code></li> <li>ClassId enum <code class="language-plaintext highlighter-rouge">[vm/class_id.h](https://github.com/dart-lang/sdk/blob/7340a569caac6431d8698dc3788579b57ffcf0c6/runtime/vm/class_id.h)</code></li> </ul> <p>It took me about two weeks to implement a command line utility that is capable of parsing a snapshot, giving us complete access to the heap of a compiled app.</p> <p>As an overview, here is the layout of clustered snapshot data:</p> <p><img src="https://blog.tst.sh/content/images/2020/02/snapshot_data-1.png" alt="" /></p> <p>Every <code class="language-plaintext highlighter-rouge">RawObject*</code> in the Isolate gets serialized by a corresponding <code class="language-plaintext highlighter-rouge">SerializationCluster</code> instance depending on its class id. These objects can contain anything from code, instances, types, primitives, closures, constants, etc. More on that later.</p> <p>After deserializing the VM isolate snapshot, every object in its heap gets added to the Isolate snapshot object pool allowing them to be referenced in the same context.</p> <p>Clusters are serialized in three stages: Trace, Alloc, and Fill.</p> <p>In the trace stage, root objects are added to a queue along with the objects they reference in a breadth first search. At the same time a <code class="language-plaintext highlighter-rouge">SerializationCluster</code> instance is created corresponding to each class type.</p> <p>Root objects are a static set of objects used by the vm in the isolate’s <code class="language-plaintext highlighter-rouge">ObjectStore</code> which we will use later to locate libraries and classes. The VM snapshot includes <code class="language-plaintext highlighter-rouge">StubCode</code> base objects which are shared between all isolates.</p> <p>Stubs are basically hand written sections of assembly that dart code calls into, allowing it to communicate safely with the runtime.</p> <p>After tracing, cluster info is written containing basic information about the clusters, most importantly the number of objects to allocate.</p> <p>In the alloc stage, each clusters <code class="language-plaintext highlighter-rouge">WriteAlloc</code> method is called which writes any information needed to allocate raw objects. Most of the time all this method does is write the class id and number of objects that are part of this cluster.</p> <p>The objects that are part of each cluster are also assigned an incrementing object id in the order they are allocated, this is used later during the fill stage when resolving object references.</p> <p>You may have noticed the lack of any indexing and cluster size information, the entire snapshot has to be read fully in order to get any meaningful data out of it. So to actually do any reverse engineering you must either implement deserialization routines for 31+ cluster types (which I have done) or extract information by loading it into a modified runtime (which is difficult to do cross-architecture).</p> <p>Here is a simplified example of what the structure of the clusters would be for an array <code class="language-plaintext highlighter-rouge">[123, 42]</code>:</p> <p><img src="https://blog.tst.sh/content/images/2020/02/cluster_alloc-3.png" alt="" /></p> <p>If an object references another object like an array element, the serializer writes the object id initially assigned during the alloc phase as shown above.</p> <p>In the case of simple objects like Mints and Smis, they are constructed entirely in the alloc stage because they don’t reference any other objects.</p> <p>After that the ~107 root refs are written including object ids for core types, libraries, classes, caches, static exceptions and several other miscellaneous objects.</p> <p>Finally, ROData objects are written which are directly mapped to <code class="language-plaintext highlighter-rouge">RawObject*</code>s in-memory to avoid an extra deserialization step.</p> <p>The most important type of ROData is <code class="language-plaintext highlighter-rouge">RawOneByteString</code> which is used for library / class / function names. ROData is also referenced by offset being the only place in the snapshot data where decoding is optional.</p> <p>Similar to ROData, <code class="language-plaintext highlighter-rouge">RawInstruction</code> objects are direct pointers to snapshot data but are stored in the executable instruction symbol rather than main snapshot data.</p> <p>Here is a dump of serialization clusters that are typically written when compiling an app:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#lint cluster-tbl
idx | cid | ClassId enum        | Cluster name
----|-----|---------------------|----------------------------------------
  0 |   5 | Class               | ClassSerializationCluster
  1 |   6 | PatchClass          | PatchClassSerializationCluster
  2 |   7 | Function            | FunctionSerializationCluster
  3 |   8 | ClosureData         | ClosureDataSerializationCluster
  4 |   9 | SignatureData       | SignatureDataSerializationCluster
  5 |  12 | Field               | FieldSerializationCluster
  6 |  13 | Script              | ScriptSerializationCluster
  7 |  14 | Library             | LibrarySerializationCluster
  8 |  17 | Code                | CodeSerializationCluster
  9 |  20 | ObjectPool          | ObjectPoolSerializationCluster
 10 |  21 | PcDescriptors       | RODataSerializationCluster
 11 |  22 | CodeSourceMap       | RODataSerializationCluster
 12 |  23 | StackMap            | RODataSerializationCluster
 13 |  25 | ExceptionHandlers   | ExceptionHandlersSerializationCluster
 14 |  29 | UnlinkedCall        | UnlinkedCallSerializationCluster
 15 |  31 | MegamorphicCache    | MegamorphicCacheSerializationCluster
 16 |  32 | SubtypeTestCache    | SubtypeTestCacheSerializationCluster
 17 |  36 | UnhandledException  | UnhandledExceptionSerializationCluster
 18 |  40 | TypeArguments       | TypeArgumentsSerializationCluster
 19 |  42 | Type                | TypeSerializationCluster
 20 |  43 | TypeRef             | TypeRefSerializationCluster
 21 |  44 | TypeParameter       | TypeParameterSerializationCluster
 22 |  45 | Closure             | ClosureSerializationCluster
 23 |  49 | Mint                | MintSerializationCluster
 24 |  50 | Double              | DoubleSerializationCluster
 25 |  52 | GrowableObjectArray | GrowableObjectArraySerializationCluster
 26 |  65 | StackTrace          | StackTraceSerializationCluster
 27 |  72 | Array               | ArraySerializationCluster
 28 |  73 | ImmutableArray      | ArraySerializationCluster
 29 |  75 | OneByteString       | RODataSerializationCluster
 30 |  95 | TypedDataInt8Array  | TypedDataSerializationCluster
 31 | 143 | &lt;instance&gt;          | InstanceSerializationCluster
...
 54 | 463 | &lt;instance&gt;          | InstanceSerializationCluster
</code></pre></div></div> <p>There are a few more clusters that could potentially be in a snapshot, but these are the only ones I have seen in a Flutter app so far.</p> <p>In DartVM there are a static set of predefined class IDs defined in the <code class="language-plaintext highlighter-rouge">ClassId</code> enum, 142 IDs as of Dart 2.4.0 to be exact. IDs outside of that (or do not have an associated cluster) are written with separate <code class="language-plaintext highlighter-rouge">InstanceSerializationCluster</code>s.</p> <p>Finally bringing the parser together I can view the structure of the snapshot from the ground up, starting with the libraries list in the root object table.</p> <p>Using the object tree here’s how you can locate a top level function, in this case <code class="language-plaintext highlighter-rouge">package:ftest/main.dart</code>s <code class="language-plaintext highlighter-rouge">main</code>: <img src="https://blog.tst.sh/content/images/2020/01/dartdec-graph-1.png" alt="" /> As you can see above the names of libraries, classes, and functions are included in release snapshots.</p> <p>Dart can’t really remove them without also obfuscating stack traces, see: <a href="https://github.com/flutter/flutter/wiki/Obfuscating-Dart-Code">https://github.com/flutter/flutter/wiki/Obfuscating-Dart-Code</a></p> <p>Obfuscation is probably not worth the effort but this will most likely change in the future and become more streamlined similar to proguard on Android or sourcemaps on the web.</p> <p>The actual machine code is stored in <code class="language-plaintext highlighter-rouge">Instructions</code> objects pointed to by <code class="language-plaintext highlighter-rouge">Code</code> objects from an offset to the start of the instruction data.</p> </div> </div> </div> </div> </body> </html>
